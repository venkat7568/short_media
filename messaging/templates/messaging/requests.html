{% extends 'base.html' %}
{% load static %}

{% block title %}Requests - Short Media Platform{% endblock %}

{% block content %}
<div class="container" style="margin-top: 2rem; margin-bottom: 6rem;">
    <div style="max-width: 700px; margin: 0 auto;">

        <h1 style="margin-bottom: 1.5rem; font-size: 1.75rem; font-weight: 700;">Requests</h1>

        <!-- Tabs -->
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--secondary-gray-light); overflow-x: auto;">
            <button class="tab-btn active" data-tab="friend" style="flex: 1; padding: 0.75rem; background: none; border: none; border-bottom: 3px solid var(--primary-green); color: var(--primary-green); font-weight: 600; cursor: pointer; white-space: nowrap;">
                üë• Friends
            </button>
            <button class="tab-btn" data-tab="knowing" style="flex: 1; padding: 0.75rem; background: none; border: none; border-bottom: 3px solid transparent; color: var(--text-secondary); font-weight: 600; cursor: pointer; white-space: nowrap;">
                ü§ù Knowing
            </button>
            <button class="tab-btn" data-tab="dating" style="flex: 1; padding: 0.75rem; background: none; border: none; border-bottom: 3px solid transparent; color: var(--text-secondary); font-weight: 600; cursor: pointer; white-space: nowrap;">
                üíï Dating
            </button>
        </div>

        <!-- Friend Requests Tab -->
        <div id="friend-tab" class="tab-content">
            <!-- Received Friend Requests -->
            {% if received_friend_requests %}
            <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">Received</h2>
            {% for friendship in received_friend_requests %}
            <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--secondary-gray-light); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0;">
                        {% if friendship.sender.profile.profile_picture %}
                        <img src="{{ friendship.sender.profile.profile_picture.url }}" alt="{{ friendship.sender.username }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        {% else %}
                        <svg style="width: 24px; height: 24px; color: var(--text-secondary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        {% endif %}
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">
                            <a href="{% url 'users:user_profile' friendship.sender.username %}" style="text-decoration: none; color: inherit;">
                                {{ friendship.sender.username }}
                            </a>
                        </h3>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: var(--secondary-gray);">
                            {{ friendship.created_at|timesince }} ago
                        </p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary accept-friend-btn" data-request-id="{{ friendship.id }}">
                            Accept
                        </button>
                        <button class="btn btn-outline reject-friend-btn" data-request-id="{{ friendship.id }}">
                            Reject
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}

            <!-- Sent Friend Requests -->
            {% if sent_friend_requests %}
            <h2 style="font-size: 1.25rem; font-weight: 600; margin: 1.5rem 0 1rem 0;">Sent</h2>
            {% for friendship in sent_friend_requests %}
            <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--secondary-gray-light); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0;">
                        {% if friendship.receiver.profile.profile_picture %}
                        <img src="{{ friendship.receiver.profile.profile_picture.url }}" alt="{{ friendship.receiver.username }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        {% else %}
                        üë§
                        {% endif %}
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">
                            <a href="{% url 'users:user_profile' friendship.receiver.username %}" style="text-decoration: none; color: inherit;">
                                {{ friendship.receiver.username }}
                            </a>
                        </h3>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: var(--secondary-gray);">Pending</p>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}

            {% if not received_friend_requests and not sent_friend_requests %}
            <div class="card" style="padding: 3rem 1rem; text-align: center;">
                <p style="font-size: 1.125rem; color: var(--secondary-gray); margin: 0;">No friend requests</p>
            </div>
            {% endif %}
        </div>

        <!-- Knowing Requests Tab -->
        <div id="knowing-tab" class="tab-content" style="display: none;">
            <!-- Received Knowing Requests -->
            {% if received_knowing_requests %}
            <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">Received Know Each Other Requests</h2>
            {% for match in received_knowing_requests %}
            <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--secondary-gray-light); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0;">
                        {% if match.sender.profile.profile_picture %}
                        <img src="{{ match.sender.profile.profile_picture.url }}" alt="{{ match.sender.username }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        {% else %}
                        üë§
                        {% endif %}
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">
                            <a href="{% url 'users:user_profile' match.sender.username %}" style="text-decoration: none; color: inherit;">
                                {{ match.sender.username }}
                            </a>
                        </h3>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: var(--secondary-gray);">
                            Wants to know you better ‚Ä¢ {{ match.created_at|timesince }} ago
                        </p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <form method="post" action="{% url 'dating:accept_knowing_request' match.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary">Accept</button>
                        </form>
                        <form method="post" action="{% url 'dating:reject_request' match.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline">Reject</button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}

            <!-- Sent Knowing Requests -->
            {% if sent_knowing_requests %}
            <h2 style="font-size: 1.25rem; font-weight: 600; margin: 1.5rem 0 1rem 0;">Sent Know Each Other Requests</h2>
            {% for match in sent_knowing_requests %}
            <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--secondary-gray-light); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0;">
                        {% if match.receiver.profile.profile_picture %}
                        <img src="{{ match.receiver.profile.profile_picture.url }}" alt="{{ match.receiver.username }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        {% else %}
                        üë§
                        {% endif %}
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">
                            <a href="{% url 'users:user_profile' match.receiver.username %}" style="text-decoration: none; color: inherit;">
                                {{ match.receiver.username }}
                            </a>
                        </h3>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: var(--secondary-gray);">Pending</p>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}

            <!-- Knowing Each Other (Accepted) -->
            {% if knowing_relationships %}
            <h2 style="font-size: 1.25rem; font-weight: 600; margin: 1.5rem 0 1rem 0;">Knowing Each Other</h2>
            {% for match in knowing_relationships %}
            <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    {% if match.sender == user %}
                    {% with other_user=match.receiver %}
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--secondary-gray-light); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0;">
                        {% if other_user.profile.profile_picture %}
                        <img src="{{ other_user.profile.profile_picture.url }}" alt="{{ other_user.username }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        {% else %}
                        üë§
                        {% endif %}
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">
                            <a href="{% url 'users:user_profile' other_user.username %}" style="text-decoration: none; color: inherit;">
                                {{ other_user.username }}
                            </a>
                        </h3>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: var(--secondary-gray);">ü§ù Knowing each other</p>
                    </div>
                    {% endwith %}
                    {% else %}
                    {% with other_user=match.sender %}
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--secondary-gray-light); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0;">
                        {% if other_user.profile.profile_picture %}
                        <img src="{{ other_user.profile.profile_picture.url }}" alt="{{ other_user.username }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        {% else %}
                        üë§
                        {% endif %}
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">
                            <a href="{% url 'users:user_profile' other_user.username %}" style="text-decoration: none; color: inherit;">
                                {{ other_user.username }}
                            </a>
                        </h3>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: var(--secondary-gray);">ü§ù Knowing each other</p>
                    </div>
                    {% endwith %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% endif %}

            <!-- Empty State -->
            {% if not received_knowing_requests and not sent_knowing_requests and not knowing_relationships %}
            <div class="card" style="text-align: center; padding: 3rem 1rem; color: var(--text-secondary);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">ü§ù</div>
                <p style="font-size: 1.1rem; margin: 0;">No knowing requests</p>
            </div>
            {% endif %}
        </div>

        <!-- Dating Requests Tab -->
        <div id="dating-tab" class="tab-content" style="display: none;">
            <!-- Received Dating Requests -->
            {% if received_dating_requests %}
            <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">Received</h2>
            {% for match in received_dating_requests %}
            <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--secondary-gray-light); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0;">
                        {% if match.sender.profile.profile_picture %}
                        <img src="{{ match.sender.profile.profile_picture.url }}" alt="{{ match.sender.username }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        {% else %}
                        üë§
                        {% endif %}
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">
                            <a href="{% url 'users:user_profile' match.sender.username %}" style="text-decoration: none; color: inherit;">
                                {{ match.sender.username }}
                            </a>
                        </h3>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: var(--secondary-gray);">
                            {{ match.created_at|timesince }} ago
                        </p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <a href="{% url 'dating:accept_request' match.id %}" class="btn btn-primary">Accept</a>
                        <a href="{% url 'dating:reject_request' match.id %}" class="btn btn-outline">Reject</a>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}

            <!-- Sent Dating Requests -->
            {% if sent_dating_requests %}
            <h2 style="font-size: 1.25rem; font-weight: 600; margin: 1.5rem 0 1rem 0;">Sent</h2>
            {% for match in sent_dating_requests %}
            <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--secondary-gray-light); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0;">
                        {% if match.receiver.profile.profile_picture %}
                        <img src="{{ match.receiver.profile.profile_picture.url }}" alt="{{ match.receiver.username }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        {% else %}
                        üë§
                        {% endif %}
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">
                            <a href="{% url 'users:user_profile' match.receiver.username %}" style="text-decoration: none; color: inherit;">
                                {{ match.receiver.username }}
                            </a>
                        </h3>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: var(--secondary-gray);">Pending</p>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}

            {% if not received_dating_requests and not sent_dating_requests %}
            <div class="card" style="padding: 3rem 1rem; text-align: center;">
                <p style="font-size: 1.125rem; color: var(--secondary-gray); margin: 0;">No dating requests</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const tab = this.getAttribute('data-tab');

        // Update buttons
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.style.borderBottom = '3px solid transparent';
            b.style.color = 'var(--text-secondary)';
            b.classList.remove('active');
        });
        this.style.borderBottom = '3px solid var(--primary-green)';
        this.style.color = 'var(--primary-green)';
        this.classList.add('active');

        // Show/hide content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'none';
        });
        document.getElementById(tab + '-tab').style.display = 'block';
    });
});

// Accept friend request
document.querySelectorAll('.accept-friend-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const requestId = this.getAttribute('data-request-id');

        try {
            const response = await fetch(`/messages/friend-request/accept/${requestId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                }
            });

            const data = await response.json();
            if (data.success) {
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });
});

// Reject friend request
document.querySelectorAll('.reject-friend-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const requestId = this.getAttribute('data-request-id');

        try {
            const response = await fetch(`/messages/friend-request/reject/${requestId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                }
            });

            const data = await response.json();
            if (data.success) {
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });
});
</script>
{% endblock %}
