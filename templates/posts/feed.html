{% extends 'base.html' %}
{% load static %}

{% block title %}Feed - Short Media Platform{% endblock %}

{% block content %}
<div class="container" style="margin-top: 2rem; margin-bottom: 2rem;">
    <div style="max-width: 700px; margin: 0 auto;">

        <!-- Create Post Card -->
        <div class="card" style="margin-bottom: 1.5rem;">
            <div class="card-body" style="padding: 1rem;">
                <form method="get" action="{% url 'posts:create_post' %}">
                    <button type="submit" class="btn btn-outline" style="width: 100%; text-align: left;">
                        What's on your mind, {{ user.username }}?
                    </button>
                </form>
                <div style="display: flex; justify-content: space-around; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--secondary-gray);">
                    <a href="{% url 'posts:create_post' %}?type=text" class="btn btn-text" style="flex: 1; margin: 0 0.25rem;">
                        üìù Text
                    </a>
                    <a href="{% url 'posts:create_post' %}?type=image" class="btn btn-text" style="flex: 1; margin: 0 0.25rem;">
                        üñºÔ∏è Image
                    </a>
                    <a href="{% url 'posts:create_post' %}?type=video" class="btn btn-text" style="flex: 1; margin: 0 0.25rem;">
                        üé• Video
                    </a>
                </div>
            </div>
        </div>

        <!-- Feed Posts -->
        {% if posts %}
            {% for post in posts %}
            <div class="card post-card" style="margin-bottom: 1.5rem;" data-post-id="{{ post.id }}">
                <!-- Post Header -->
                <div class="card-header" style="display: flex; align-items: center; padding: 1rem;">
                    <div style="flex: 1;">
                        <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">
                            {{ post.author.username }}
                        </h3>
                        <p style="margin: 0; font-size: 0.875rem; color: var(--secondary-gray);">
                            {{ post.created_at|timesince }} ago
                        </p>
                    </div>
                    {% if post.author == user %}
                    <form method="post" action="{% url 'posts:delete_post' post.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this post?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-text" style="color: var(--danger);">
                            Delete
                        </button>
                    </form>
                    {% endif %}
                </div>

                <!-- Post Content -->
                <div class="card-body">
                    {% if post.post_type == 'TEXT' %}
                        <p style="white-space: pre-wrap; margin-bottom: 0;">{{ post.textpost.text }}</p>
                    {% elif post.post_type == 'IMAGE' %}
                        <p style="white-space: pre-wrap;">{{ post.imagepost.caption }}</p>
                        <img src="{{ post.imagepost.image.url }}" alt="Post image" style="width: 100%; border-radius: 8px;">
                    {% elif post.post_type == 'VIDEO' %}
                        <p style="white-space: pre-wrap;">{{ post.videopost.caption }}</p>
                        <video controls style="width: 100%; border-radius: 8px;">
                            <source src="{{ post.videopost.video.url }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    {% endif %}
                </div>

                <!-- Post Stats -->
                <div style="padding: 0.5rem 1rem;">
                    <span style="font-weight: 600; font-size: 1rem;" class="hash-count">
                        {% if post.likes_count >= 1000 %}
                            {{ post.likes_count|floatformat:0|slice:":-3" }}k
                        {% else %}
                            {{ post.likes_count }}
                        {% endif %}
                    </span>
                </div>

                <!-- Post Actions -->
                <div style="display: flex; padding: 0.5rem; border-top: 1px solid var(--secondary-gray-light);">
                    <button class="btn btn-text hash-btn" data-post-id="{{ post.id }}" style="flex: 1; font-size: 1.5rem; {% if post.id in user_liked_post_ids %}color: var(--primary-green);{% endif %}">
                        #
                    </button>
                    <a href="{% url 'posts:post_detail' post.id %}" class="btn btn-text" style="flex: 1; font-size: 1.5rem;">
                        üí¨
                    </a>
                    <button class="btn btn-text share-btn" data-post-id="{{ post.id }}" style="flex: 1; font-size: 1.5rem;">
                        ‚û§
                    </button>
                </div>

                <!-- Recent Comments Preview -->
                {% if post.comments_count > 0 %}
                <div style="padding: 0 1rem 1rem 1rem; border-top: 1px solid var(--secondary-gray-light);">
                    {% for comment in post.comment_set.all|slice:":2" %}
                    <div style="margin-top: 0.75rem; padding: 0.75rem; background: var(--secondary-gray-light); border-radius: 12px;">
                        <p style="margin: 0; font-weight: 600; font-size: 0.875rem;">{{ comment.author.username }}</p>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem;">{{ comment.text }}</p>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem; color: var(--secondary-gray);">
                            {{ comment.created_at|timesince }} ago
                        </p>
                    </div>
                    {% endfor %}
                    {% if post.comments_count > 2 %}
                    <a href="{% url 'posts:post_detail' post.id %}" style="display: block; margin-top: 0.5rem; font-size: 0.875rem; color: var(--primary-green); text-decoration: none;">
                        View all {{ post.comments_count }} comments
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}

            <!-- Load More Button -->
            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-outline" id="load-more-btn">
                    Load More
                </button>
            </div>
        {% else %}
            <div class="card">
                <div class="card-body" style="text-align: center; padding: 3rem 1rem;">
                    <p style="font-size: 1.25rem; color: var(--secondary-gray); margin: 0;">
                        No posts yet. Be the first to post!
                    </p>
                    <a href="{% url 'posts:create_post' %}" class="btn btn-primary" style="margin-top: 1rem;">
                        Create Post
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
// AJAX for hash button
document.querySelectorAll('.hash-btn').forEach(button => {
    button.addEventListener('click', async function() {
        const postId = this.getAttribute('data-post-id');
        const postCard = document.querySelector(`.post-card[data-post-id="${postId}"]`);
        const hashCountEl = postCard.querySelector('.hash-count');

        try {
            const response = await fetch(`/posts/${postId}/like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (data.status === 'liked') {
                this.style.color = 'var(--primary-green)';
            } else {
                this.style.color = '';
            }

            // Format count (k for thousands)
            let displayCount = data.likes_count;
            if (data.likes_count >= 1000) {
                displayCount = Math.floor(data.likes_count / 1000) + 'k';
            }
            hashCountEl.textContent = displayCount;
        } catch (error) {
            console.error('Error:', error);
        }
    });
});

// Share button functionality
document.querySelectorAll('.share-btn').forEach(button => {
    button.addEventListener('click', async function() {
        const postId = this.getAttribute('data-post-id');
        const postUrl = `${window.location.origin}/posts/${postId}/`;

        if (navigator.share) {
            try {
                await navigator.share({
                    title: 'Check out this post on Short Media',
                    url: postUrl
                });
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Error sharing:', err);
                    copyToClipboard(postUrl);
                }
            }
        } else {
            copyToClipboard(postUrl);
        }
    });
});

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('Link copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy link. Please try again.');
    });
}
</script>
{% endblock %}
