{% extends 'base.html' %}
{% load static %}

{% block title %}Post by {{ post.author.username }} - Short Media Platform{% endblock %}

{% block content %}
<div class="container" style="margin-top: 2rem; margin-bottom: 2rem;">
    <div style="max-width: 700px; margin: 0 auto;">

        <!-- Back Button -->
        <a href="{% url 'posts:feed' %}" class="btn btn-text" style="margin-bottom: 1rem;">
            ‚Üê Back to Home
        </a>

        <!-- Post Card -->
        <div class="card post-card" style="margin-bottom: 1.5rem;" data-post-id="{{ post.id }}">
            <!-- Post Header -->
            <div class="card-header" style="display: flex; align-items: center; padding: 1rem;">
                <div style="flex: 1;">
                    <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">
                        {{ post.author.username }}
                    </h3>
                    <p style="margin: 0; font-size: 0.875rem; color: var(--secondary-gray);">
                        {{ post.created_at|date:"F d, Y" }} at {{ post.created_at|time:"g:i A" }}
                    </p>
                </div>
                {% if post.author == user %}
                <form method="post" action="{% url 'posts:delete_post' post.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this post?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-text" style="color: var(--danger);">
                        Delete
                    </button>
                </form>
                {% endif %}
            </div>

            <!-- Post Content -->
            <div class="card-body">
                {% if post.post_type == 'TEXT' %}
                    <p style="white-space: pre-wrap; margin-bottom: 0;">{{ post.textpost.text }}</p>
                {% elif post.post_type == 'IMAGE' %}
                    <p style="white-space: pre-wrap;">{{ post.imagepost.caption }}</p>
                    <img src="{{ post.imagepost.image.url }}" alt="Post image" style="width: 100%; border-radius: 8px;">
                {% elif post.post_type == 'VIDEO' %}
                    <p style="white-space: pre-wrap;">{{ post.videopost.caption }}</p>
                    <video controls style="width: 100%; border-radius: 8px;">
                        <source src="{{ post.videopost.video.url }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                {% endif %}
            </div>

            <!-- Post Stats -->
            <div style="padding: 0.5rem 1rem; border-top: 1px solid var(--secondary-gray-light); border-bottom: 1px solid var(--secondary-gray-light);">
                <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: var(--secondary-gray);">
                    <span class="likes-count">{{ post.likes_count }} like{{ post.likes_count|pluralize }}</span>
                    <span class="comments-count">{{ comments.count }} comment{{ comments.count|pluralize }}</span>
                </div>
            </div>

            <!-- Post Actions -->
            <div style="display: flex; padding: 0.5rem;">
                <button class="btn btn-text like-btn" data-post-id="{{ post.id }}" style="flex: 1; {% if user_has_liked %}color: var(--primary-green);{% endif %}">
                    {% if user_has_liked %}‚ù§Ô∏è{% else %}ü§ç{% endif %} Like
                </button>
                <button class="btn btn-text" onclick="document.getElementById('comment-input').focus()" style="flex: 1;">
                    üí¨ Comment
                </button>
            </div>
        </div>

        <!-- Comments Section -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Comments</h2>
            </div>

            <!-- Add Comment Form -->
            <div class="card-body" style="border-bottom: 1px solid var(--secondary-gray-light);">
                <form method="post" id="comment-form">
                    {% csrf_token %}
                    <div class="form-group" style="margin-bottom: 0;">
                        <textarea
                            name="text"
                            id="comment-input"
                            class="form-control"
                            rows="2"
                            placeholder="Write a comment..."
                            required
                            style="resize: vertical;"
                        ></textarea>
                        <button type="submit" class="btn btn-primary" style="margin-top: 0.5rem;">
                            Post Comment
                        </button>
                    </div>
                </form>
            </div>

            <!-- Comments List -->
            <div class="card-body" id="comments-list">
                {% if comments %}
                    {% for comment in comments %}
                    <div class="comment" style="margin-bottom: 1rem; padding-bottom: 1rem; {% if not forloop.last %}border-bottom: 1px solid var(--secondary-gray-light);{% endif %}">
                        <div style="display: flex; align-items: start; gap: 0.75rem;">
                            <div style="flex: 1;">
                                <div style="background: var(--secondary-gray-light); padding: 0.75rem; border-radius: 12px;">
                                    <p style="margin: 0; font-weight: 600; font-size: 0.875rem;">
                                        {{ comment.author.username }}
                                    </p>
                                    <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; white-space: pre-wrap;">
                                        {{ comment.text }}
                                    </p>
                                </div>
                                <p style="margin: 0.25rem 0 0 0.75rem; font-size: 0.75rem; color: var(--secondary-gray);">
                                    {{ comment.created_at|timesince }} ago
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="text-align: center; color: var(--secondary-gray); margin: 2rem 0;">
                        No comments yet. Be the first to comment!
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// AJAX for like button
document.querySelector('.like-btn').addEventListener('click', async function() {
    const postId = this.getAttribute('data-post-id');
    const postCard = document.querySelector(`.post-card[data-post-id="${postId}"]`);
    const likesCountEl = postCard.querySelector('.likes-count');

    try {
        const response = await fetch(`/posts/${postId}/like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        });

        const data = await response.json();

        if (data.status === 'liked') {
            this.innerHTML = '‚ù§Ô∏è Like';
            this.style.color = 'var(--primary-green)';
        } else {
            this.innerHTML = 'ü§ç Like';
            this.style.color = '';
        }

        likesCountEl.textContent = `${data.likes_count} like${data.likes_count !== 1 ? 's' : ''}`;
    } catch (error) {
        console.error('Error:', error);
    }
});

// AJAX for comment form
document.getElementById('comment-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const commentText = formData.get('text');

    if (!commentText.trim()) {
        return;
    }

    try {
        const response = await fetch(window.location.href, {
            method: 'POST',
            body: formData,
        });

        if (response.ok) {
            // Reload the page to show the new comment
            window.location.reload();
        }
    } catch (error) {
        console.error('Error:', error);
    }
});
</script>
{% endblock %}
